# Concepts

The Azure IoT Hub portal inherit from Azure IoT Hub concepts for mananing IoT devices.

Inside the Portal, the solution leverage the following concepts:

- IoT Device Provisioning
- IoT Hub Device Twin
- IoT Hub Device Twin Properties
- IoT Hub Edge deployment manifest
- Cloud To Device Message

## Device models

By using this capability, the application can create logical representation of IoT devices. This feature is designed to configure a set of sharable properties between devices. 
When creating a device, the user is prompted to specify the device model. The application will then apply the properties of the device model to the device.

![./assets/images/device-model.png](./assets/images/device-model.png)

### Parameters

* ``Device Model Id``: The ID of the device model.
> Note: Since the device model is shared among all the devices, the ID should be unique. For convinience, the ID is generated by the application. By sing the API, the ID is not required, if provided, it will be used as the ID of the device model.
* ``Name``: The name of the device model.
* ``Description``: The description of the device model.

### Built-in models

Built-in models are predefined device models that can be used by the application. 
This functionnality is exactly the same as standard device models except that **the properties are not editable and the device model is not deletable** viat the Portal.

> Note: Create and update a Built-in models are not available in the portal. They can be managed on through the Azure IoT Hub portal APIs.
> 
> see [Device Model API reference]( ./open-api.html#tocS_DeviceModel) for more information.

## Devices

Devices are the physical IoT devices that are provisioned by the application. They are represented by an object that is stored in the Azure IoT Hub as the device twin.

![./assets/images/device-twin.png](./assets/images/device-twin.png)

### Parameters

* ``Device Id``: The ID of the device.
> Note: Device id the same as the device id stored in the Azure IoT Hub. It is prompte to the user when creating a device and is not editable after the device is created.
* ``Name``: The name of the device model.
> Note: The device name, is the device friendly name. The name is editable after the device is created.
* ``Device Model``: The device model that the device is based on.
> Note: The device model is prompted to the user during the device creation and is not editable after the device is created.
* ``Status``: The status of the device.
> Note: The status is related to the Device status in the Azure IoT Hub.

### Device Twin tags

To store additional information about the device, the application uses device twin tags.

| Name       	| Position        	| Description                                                                                                                                                  	|
|------------	|-----------------	|--------------------------------------------------------------------------------------------------------------------------------------------------------------	|
| deviceName 	| ``tags.deviceName`` 	| Field that contains the device friendly name.<br>_**note**: if not set, the portal will show the device id instead of the device name until its configured._ 	|
| modelId    	| ``tags.modelId``    	| Field that contains the device model identifier that the device is related.<br>_**note**: if not set, the device is not usable on the IoT hub portal._       	|
| deviceType 	| ``tags.deviceType`` 	| Field that contains a human readable device type (ex: 'LoRa Device')                                                                                         	|

## IoT Edge

IoT Edge is fully herited from Azure IoT Hub concepts. By the portal, the user can mangage the IoT Edge devices from Azure IoT Hub.
For more information about Azure IoT Edge, see [Azure IoT Edge documentation](https://docs.microsoft.com/en-us/azure/iot-edge/).

![./assets/images/iot-edge.png](./assets/images/iot-edge.png)

### Parameters

* ``Type``: The type of the IoT Edge device.
> Note: related to the IoT Edge purpose tag vaiue that might be used to create deployment manifests.
* ``Environment``: The IoT Edge device environment (Development, Production, QA).
> Note: this is an additional field that can be used to create deployment manifests.
* ``Status``: The status of the device.
> Note: The status is related to the Device status in the Azure IoT Hub.
* ``Nbr of connected devices``: The number of devices connected to the IoT Edge device.
> Note: The number of connected devices is related to the number of connections that are currently present in the edgeHub module.
> This might be different from the number of devices connected to the IoT Edge device if some modules are using edgeHub connections.
* ``Nbr of desired modules``: The number of modules that are desired in the last deployment.

### Last deployment

The last deployment topic is related to the last deployment manifest of that is currently applied to the IoT Edge device.

### IoT Edge Module

The IoT Edge module section represents the modules that are currently deployed on the IoT Edge device. It doesn't include the system modules of IoT Edge (edgeAgent and edgeHub).
By the portail, the user can interact with those modules and manage them (Get last module logs, restart module, etc.).

### Device Twin tags

To store additional information about the device, the application uses device twin tags.

| Name    	| Position     	| Description                                                                                                                                 	|
|---------	|--------------	|---------------------------------------------------------------------------------------------------------------------------------------------	|
| Purpose 	| ``tags.purpose`` 	| Field that contains the Device Type value.<br>_**note**: this is the tag that might be used to target deployment manifest for the IoT Edge_ 	|
| Environment 	| ``tags.env`` 	| Field that contains the Device Environment value.<br>_**note**: this is the tag that might be used to target deployment manifest for the IoT Edge_ 	|

### DPS Enrollment groups

The IoT Hub portal leverage on Azure Device Provisioning Enrollement groups to manage IoT Edge device connection strings.
On click to "Connect" button in the IoT Edge details page, the user can access to the device unique credentials in the enrollment group.

> Note: see [Provision the device with its cloud identity
](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-provision-devices-at-scale-linux-symmetric?view=iotedge-2020-11&tabs=individual-enrollment%2Cubuntu#provision-the-device-with-its-cloud-identity) to know how to configure the IoT Edge to use these credentials to connect to the platform.

Fom more information, see [Azure Device Provisioning Enrollement groups](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-dev-preview-enrollment-groups).

## IoT Edge Configuration

The IoT Edge configuration concerns the IoT Edge deployment manifest that are currently present in the IoT Hub.
The portal can be used to see the details of the configuration. 

> Note: at that time the portal cannot be used to update the configuration.

![./assets/images/edge-configuration.png](./assets/images/edge-configuration.png)

### Target

The parameters are related to the IoT Edge deployment manifest target condition field.
The IoT Hub portal will use the Target condition to extract this values from the deployment manifest.

| Name        	| Position       	| Description                                              	|
|-------------	|----------------	|----------------------------------------------------------	|
| Owner       	| ``tags.owner`` 	| Owner tag filter condition from the Deployment Manifest. 	|
| Environment 	| ``tags.env``   	| Environment tag filter from the Deployment Manifest.     	|
| Type        	| ``tags.type``  	| Device type tag filter from the Deployment Manifest.     	|

# LoRa WAN

LoRaWAN features are activated by default providing in the Portal the way to configure IoT Devices that supports LoRaWAN connectivity.
Internally, the LoRaWAN connectivity is expected to be provided by [IoTEdge LoRaWAN StarterKit](https://github.com/Azure/iotedge-lorawan-starterkit/). The IoT Hub portal will manage devices by modifying there twin properties to make them working with this solution.

## Device models

As for regulare Device Models the IoT hub portal provides the possibility to manage LoRa WEN device models.
To activate the LoRa WAN features on the device model, user have to select that on the `LoRa Device` compatibility

![./assets/images/lora-feature-device-model-toggle.png](./assets/images/lora-feature-device-model-toggle.png)

> Note: once activated, the device model detail activate a new tab called "LoRaWAN" that presents new settings for the device model.

![./assets/images/lorawan-device-model.png](./assets/images/lorawan-device-model.png)

### Parameters

The parameters for the device models are parameters that are stored in the IoT Hub portal and retrieved for devices that inherits from this device model.

> Note: At that time, some of this settings are not automatically changed on devices when changed to the device model. Only commands will be automatically avilable on device details after the model modification.
>
> In that case, user should then modify each device and re-save it to get the correct properties.

* ``OTAA AppEUI``: The device model OTAA App EUI used for the device during the OTAA Join procedure.
* ```Sensor Decoder URL```: The Sensor Decoder URL that the network server should use to decode frames comming from the devices that inherit from this model.

### Commands

The devices commands are pre-stored frames that the user can add to the device model and then will be able to use on device detail page to launch to the device.

* ``Name``: The command name. This name is only a friendly name that the user can set to understand what the command is supposed to do.
* ```Frame```: The LoRaWAN frame (in hexa) to be sent to the device.

## Devices

LoRa WAN devices are accessible from the IoT Hub portal for devices that inherits from the LoRaWAN device model.
The LoRaWAN tab presents the device details.

![./assets/images/lorawan-device-details.png](./assets/images/lorawan-device-details.png)

> Note:by selecting the correct device model on the first tab, the portal will automatically take LoRaWAN settings from the device model to apply on the device.

## Command Execution

To execute the command, the device should have joined the network. The message below explain that the device have to be connected to the network ant commands are disabled until the device is connected to the network.

![./assets/images/lorawan-device-not-joined-message.png](./assets/images/lorawan-device-not-joined-message.png)

#### Command execution flow

The schema below explain how the command execution flow works.

<div class="mermaid">
sequenceDiagram
    User->>+IoT Hub Portal: Send Command (DeviceId, FrameId)
    IoT Hub Portal->>+LoRa Key Management Facade: POST /api/cloudtodevicemessage
    LoRa Key Management Facade->>+Azure IoT Hub: Invoke Device Method to Network Server
    Azure IoT Hub-->>-LoRa Key Management Facade: Cloud To Device Method Result
    LoRa Key Management Facade-->>-IoT Hub Portal: Send Cloud To Device Message Result
    IoT Hub Portal-->>-User: Command send result
</div>

> See [https://azure.github.io/iotedge-lorawan-starterkit/2.0.0/quickstart/#cloud-to-device-message](https://azure.github.io/iotedge-lorawan-starterkit/2.0.0/quickstart/#cloud-to-device-message) for more information about the Cloud To Device Message involed  in the LoRa WAN device commands execution flow.