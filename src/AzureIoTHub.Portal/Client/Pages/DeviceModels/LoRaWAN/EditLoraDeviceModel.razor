@using AzureIoTHub.Portal.Shared.Models.V10.LoRaWAN.LoRaDeviceModel

<MudItem xs="12">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText>LoRaWAN</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudText>@(LoRaDeviceModel.UseOTAA ? "OTAA setting enable" : "APB setting enable")</MudText>
                </MudItem>
                <MudDivider Class="my-4"></MudDivider>
                <MudItem md="6" xs=12>
                    <MudGrid>
                        @if (LoRaDeviceModel.UseOTAA)
                        {
                            <MudItem xs="12">
                                <MudTextField @bind-Value="@LoRaDeviceModel.AppEUI" Label="OTAA AppEUI" For="@(() => LoRaDeviceModel.AppEUI)" Margin="Margin.Dense" Variant="Variant.Outlined" Required="true"></MudTextField>
                            </MudItem>
                        }
                        else
                        {
                            <MudItem xs="12">
                                <MudSwitch T="bool?" @bind-Checked="@LoRaDeviceModel.ABPRelaxMode" For="@(() => LoRaDeviceModel.ABPRelaxMode)" Label="Disable ABP relax mode" Color="Color.Primary"></MudSwitch>
                            </MudItem>
                        }
                        <MudItem xs="12">
                            <MudTextField @bind-Value="@LoRaDeviceModel.SensorDecoder" Label="Sensor Decoder URL" For="@(() => LoRaDeviceModel.SensorDecoder)" Margin="Margin.Dense" Variant="Variant.Outlined"></MudTextField>
                        </MudItem>
                    </MudGrid>
                </MudItem>
                <MudItem md="6" xs=12>
                    <MudGrid>
                        <MudItem md="6" xs="12">
                            <MudNumericField @bind-Value="@LoRaDeviceModel.KeepAliveTimeout" For="@(() => LoRaDeviceModel.KeepAliveTimeout)" Min=1 Label="Device Connection Timeout" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                        </MudItem>
                        <MudItem md="6" xs="12">
                            <MudSelect T=string @bind-Value="@LoRaDeviceModel.Deduplication" For="@(() => LoRaDeviceModel.Deduplication)" AnchorOrigin="Origin.BottomCenter" Label="Message Deduplication" Margin="Margin.Dense" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("Mark")"></MudSelectItem>
                                <MudSelectItem Value="@("Drop")"></MudSelectItem>
                                <MudSelectItem Value="@("None")"></MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4"></MudDivider>

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo=Typo.h5 Class="mb-4">Receive Windows</MudText>
                    <MudGrid>
                        <MudItem xs="12">
                            <MudSwitch @bind-Checked="@LoRaDeviceModel.Downlink" For="@(() => LoRaDeviceModel.Downlink)" Label="Enable/disable downstream messages" Color="Color.Primary"></MudSwitch>
                        </MudItem>
                        @if (LoRaDeviceModel.Downlink.HasValue && LoRaDeviceModel.Downlink.Value)
                        {
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.PreferredWindow" For="@(() => LoRaDeviceModel.PreferredWindow)" Min="1" Max="2" Label="Preferred receive window" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.RXDelay" For="@(() => LoRaDeviceModel.RXDelay)" Min=1 Label="RX Delay" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.RX1DROffset" For="@(() => LoRaDeviceModel.RX1DROffset)" Label="RX1 Datarate Offset" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.RX2DataRate" For="@(() => LoRaDeviceModel.RX2DataRate)" Label="RX2 Datarate" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>

                <MudItem xs="6">
                    <MudText Typo=Typo.h5 Class="mb-4">Frame Counters</MudText>
                    <MudGrid>
                        <MudItem xs="12">
                            <MudSwitch @bind-Checked="@LoRaDeviceModel.Supports32BitFCnt" For="@(() => LoRaDeviceModel.Supports32BitFCnt)" Label="32bit counter support" Color="Color.Primary" Margin="Margin.Dense" Variant="Variant.Outlined"></MudSwitch>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="@LoRaDeviceModel.FCntUpStart" For="@(() => LoRaDeviceModel.FCntUpStart)" Min=0 Label="Frame counter up start value" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                        </MudItem>
                        @if (LoRaDeviceModel.Downlink.HasValue && LoRaDeviceModel.Downlink.Value)
                        {
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.FCntDownStart" For="@(() => LoRaDeviceModel.FCntDownStart)" Min=0 Label="Frame counter down start value" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="@LoRaDeviceModel.FCntResetCounter" For="@(() => LoRaDeviceModel.FCntResetCounter)" Min=0 Label="Frame counter reset counter value" Margin="Margin.Dense" Variant="Variant.Outlined"></MudNumericField>
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>
            </MudGrid>
            
            <MudDivider Class="my-4"></MudDivider>

            @if (LoRaDeviceModel.Downlink.HasValue && LoRaDeviceModel.Downlink.Value)
            {
                <MudItem xs="12">
                    <MudTable Items="@Commands" Dense=true Hover=true Bordered=true Striped=true>
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Commands</MudText>
                            <MudSpacer />
                        </ToolBarContent>
                        <ColGroup>
                            <col style="width: 30%;" />
                            <col style="width: 60%;" />
                            <col style="width: 10%;" />
                            <col style="width: 5%;" />
                        </ColGroup>
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh Style="text-align: center">Frame</MudTh>
                            <MudTh Style="text-align: center">Port</MudTh>
                            <MudTh Style="text-align: center">Delete</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="CommandContext">
                            <MudTd DataLabel="Name" Style="word-break: break-all;">
                                <MudTextField @bind-Value="@CommandContext.Name" Label="Name" For="@(() => CommandContext.Name)" Margin="Margin.Dense" Variant="Variant.Outlined" Required="true" Disabled="CommandContext.IsBuiltin"></MudTextField>
                            </MudTd>
                            <MudTd DataLabel="Frame" Style="word-break: break-all; ">
                                <MudTextField @bind-Value="@CommandContext.Frame" Label="Frame" For="@(() => CommandContext.Frame)" Margin="Margin.Dense" Variant="Variant.Outlined" Required="true" Disabled="CommandContext.IsBuiltin"></MudTextField>
                            </MudTd>
                            <MudTd DataLabel="Port" Style="text-align: center;">
                                <MudNumericField @bind-Value="@CommandContext.Port" Label="Port" For="@(() => CommandContext.Port)" Margin="Margin.Dense" Variant="Variant.Outlined" Disabled="CommandContext.IsBuiltin"></MudNumericField>
                            </MudTd>
                            <MudTd DataLabel="Delete" Style="text-align: center">
                                <MudIconButton Color="Color.Default" Icon="@Icons.Material.Filled.Delete" Size="Size.Medium" Disabled="@CommandContext.IsBuiltin" OnClick="@(() => DeleteCommand(CommandContext))"></MudIconButton>
                            </MudTd>
                        </RowTemplate>
                        <FooterContent>
                            <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" Color="Color.Success" OnClick="AddCommand">Add Command</MudButton>
                        </FooterContent>
                    </MudTable>
                </MudItem>
            }
        </MudCardContent>
        <MudCardActions Class="pb-4 pl-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="OnSaveClick">Save Changes</MudButton>
        </MudCardActions>
    </MudCard>
</MudItem>

@code {
    [Parameter]
    public LoRaDeviceModel LoRaDeviceModel { get; set; }

    [Parameter]
    public IList<DeviceModelCommand> Commands { get; set; }

    [Parameter]
    public EventCallback OnSaveClick { get; set; }

    private DeviceModelCommand DeviceModelCommand { get; set; } = new DeviceModelCommand();

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    private void AddCommand()
    {
        var last = Commands.LastOrDefault();

        if (Commands.Count == 0 || (last.Name is not null && last.Frame is not null))
        {
            Commands.Add(new DeviceModelCommand());
        }
    }

    private void DeleteCommand(DeviceModelCommand item)
    {
        Commands.Remove(item);
    }
}
