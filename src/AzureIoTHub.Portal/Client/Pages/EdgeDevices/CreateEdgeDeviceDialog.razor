@page "/edge/devices/add"
@using AzureIoTHub.Portal.Models.v10;

@inject ISnackbar Snackbar
@inject IEdgeDeviceClientService EdgeDeviceClientService

<MudDialog Class="d-flex align-center justify-center" style="width:fit-content;">
    <DialogContent>
        <EditForm Model="@gateway" OnValidSubmit="OnValidation">
            <DataAnnotationsValidator />
            <MudCard style="width:60vh;">
                <MudCardContent>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="@gateway.DeviceId"
                                      id="name"
                                      Label="Name"
                                      Variant="Variant.Text"
                                      For="@(() => gateway.DeviceId)"
                                      Required="true" />
                    </MudItem>

                </MudCardContent>
                <MudCardActions Class="pb-4 pl-4">
                    <MudButton id="cancel" Variant="Variant.Outlined" Color="Color.Dark" Class="ml-auto" @onclick="Cancel">Cancel</MudButton>

                    @if (processingSave)
                    {
                        <MudButton Variant="Variant.Filled" Class="ml-4" Color="Color.Primary" Disabled="true">
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />Processing
                        </MudButton>
                    }
                    else
                    {
                        <MudButton id="create" ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-4">Create</MudButton>
                    }
                </MudCardActions>
            </MudCard>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    public Error Error {get; set;}
    
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    private readonly IoTEdgeDevice gateway = new();
    private bool processingSave;

    void Cancel() => MudDialog.Cancel();

    private async Task OnValidation()
    {
        try
        {
            processingSave = true;
            await EdgeDeviceClientService.CreateDevice(gateway);

            Snackbar.Add("Device has been successfully created!\r\nPlease note that changes might take some minutes to be visible in the list...", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (ProblemDetailsException exception)
        {
            Error?.ProcessProblemDetails(exception);
        }
        finally
        {
            processingSave = false;
        }
    }
}
