@page "/devices"

@attribute [Authorize]

@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject PortalSettings Portal
@inject IDeviceTagSettingsClientService DeviceTagSettingsClientService
@inject IDeviceClientService DeviceClientService
@inject IJSRuntime Js
@inject IDeviceModelsClientService DeviceModelsClientService

<MudGrid>
    <MudItem xs="12">
        <MudDataGrid T="DeviceListItem" ServerData="LoadItems" @ref="devicesGrid"
                     Dense="true" Hover="true" Bordered="true" Striped="true"
                     Filterable="true" FilterMode="DataGridFilterMode.ColumnFilterMenu" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                     SortMode="SortMode.Single"
                     Groupable="true"
                     Loading="@IsLoading"
                     RowClick="@((e) => GoToDetails(e.Item))"
                     RowStyle="cursor: pointer;">
            <Columns>
                <TemplateColumn Title="Device model" Sortable="false" GroupBy="item => item.DeviceModelId">
                    <CellTemplate>
                        <img src="@context.Item?.Image" height="25px" alt="Device model image" />
                    </CellTemplate>
                    <FilterTemplate>
                        @* <DeviceModelDataGridFilter Items="@deviceModels" Context="@context" SelectedModels="@selectedDeviceModels" /> *@
                        <MudStack Spacing="0">
                            @* <MudCheckBox T="bool" Label="Select All"
                            Size="Size.Small"
                            Value="@selectAll" ValueChanged="@SelectAll" /> *@
                            <MudStack Spacing="0">
                                @foreach (var item in deviceModels)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Wrap="Wrap.NoWrap">
                                        <MudCheckBox T="bool"
                                                     Size="Size.Small"
                                                     Value="@(selectedDeviceModels.Contains(item))"
                                                     ValueChanged="@((value) => { if (value) selectedDeviceModels.Add(item);else selectedDeviceModels.Remove(item); })" />
                                        <img src="@(item.Image)" alt="@(item.Image) device model image" />
                                        <MudText>@item.Name</MudText>
                                    </MudStack>
                                }
                            </MudStack>
                            <MudStack Row="true">
                                <MudButton Color="@Color.Primary" OnClick="@Refresh">Filter</MudButton>
                            </MudStack>
                        </MudStack>

                    </FilterTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Device" SortBy="item => item.Name" InitialDirection="SortDirection.Ascending" Filterable="false">
                    <CellTemplate>
                        <MudItem>
                            <MudText Typo="Typo.body1" Inline="true">@context.Item.Name</MudText>
                            <MudText Class="pl-2" Typo="Typo.caption" Style="@($"color:{Theme.CurrentTheme.Palette.GrayLight};")" Inline="true">@context.Item?.DeviceID</MudText>
                        </MudItem>
                        <MudItem>
                            <Labels Items="@context.Item?.Labels" SearchedLabels="@labels" />
                        </MudItem>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Allowed" SortBy="item => item.IsEnabled">
                    <CellTemplate>
                        @if (context.Item?.IsEnabled != null && (bool)context.Item?.IsEnabled)
                        {
                            <MudTooltip Text="Device can connect">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                            </MudTooltip>
                        }
                        else
                        {
                            <MudTooltip Text="Device cannot connect">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Default" />
                            </MudTooltip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Connection state" Sortable="true">
                    <CellTemplate>
                        @if (context.Item?.IsConnected != null && (bool)context.Item?.IsConnected)
                        {
                            <MudTooltip Text="Device is connected">
                                <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="Color.Success" />
                            </MudTooltip>
                        }
                        else
                        {
                            <MudTooltip Text="Device is not connected">
                                <MudIcon Icon="@Icons.Material.Filled.WifiOff" Color="Color.Error" />
                            </MudTooltip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.StatusUpdatedTime" Title="Last status update" Sortable="false" Filterable="false" Format="" />
                <TemplateColumn Title="Telemetry" Hidden="@(!Portal.IsLoRaSupported)" Sortable="false" Filterable="false">
                    <CellTemplate>
                        <MudTooltip Text="See device telemetry">
                            <MudIconButton id="@($"show-device-telemetry-{context.Item.DeviceID}")"
                                           Icon="@Icons.Material.Filled.ShowChart" Color="Color.Default"
                                           OnClick="@(() => ShowDeviceTelemetry(context.Item))" />
                        </MudTooltip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="See details" Sortable="false" Filterable="false">
                    <CellTemplate>
                        <MudTooltip Text="See device details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Default" OnClick="@(() => GoToDetails(context.Item))" />
                        </MudTooltip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Delete" Sortable="false" Filterable="false">
                    <CellTemplate>
                        <MudTooltip Text="Delete device">
                            <MudIconButton id="@($"delete-device-{context.Item.DeviceID}")"
                                           Icon="@Icons.Material.Filled.Delete" Color="Color.Default" Size="Size.Medium"
                                           OnClick="@(_ => DeleteDevice(context.Item))" />
                        </MudTooltip>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <ToolBarContent>
                <MudText Typo="Typo.h6">Devices</MudText>
                <MudSpacer />
                <MudTextField T="string" InputType="InputType.Text" Placeholder="Search a device"
                              Value="@searchString" ValueChanged="@Search"
                              Immediate="false"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                              Class="mt-0" />
                <MudTooltip Text="Refresh list">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="@Refresh" Size="Size.Medium" id="tableRefreshButton" Class="ma-1"></MudIconButton>
                </MudTooltip>
                <MudTooltip Text="Add device">
                    <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" OnClick="AddDevice" id="addDeviceButton" Class="ma-1" />
                </MudTooltip>

                <MudButton id="manageDevicesButtonToggle" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">
                    Manage devices
                    <MudPopover Open="@menuIsOpen" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.TopRight">
                        <MudItem>
                            <MudButton id="exportDevicesButton" Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Outlined.Download" OnClick="ExportDeviceList">Export device list</MudButton>
                        </MudItem>
                        <MudItem>
                            <MudButton id="exportTemplateButton" Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download" OnClick="ExportTemplateFile">Download template file</MudButton>
                        </MudItem>
                        <MudItem>
                            <MudFileUpload T="IBrowserFile" FilesChanged="ImportDeviceList">
                                <ButtonTemplate>
                                    <MudButton id="importDevicesButton" Variant="Variant.Text"
                                               HtmlTag="label"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Outlined.Upload"
                                               for="@context">
                                        Import device list
                                    </MudButton>
                                </ButtonTemplate>
                            </MudFileUpload>
                        </MudItem>
                    </MudPopover>
                </MudButton>
            </ToolBarContent>

            <NoRecordsContent>
                <MudText>No matching records found</MudText>
            </NoRecordsContent>

            <LoadingContent>
                <MudText>Loading...</MudText>
            </LoadingContent>

            <PagerContent>
                <MudTablePager PageSizeOptions="@pageSizeOptions" />
            </PagerContent>
        </MudDataGrid>
    </MudItem>
</MudGrid>
