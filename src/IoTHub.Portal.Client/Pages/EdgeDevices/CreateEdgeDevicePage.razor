@page "/edge/devices/new"
@inherits AuthorizedComponentBase

@attribute [Authorize]

@inject PortalSettings Portal
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IEdgeDeviceClientService EdgeDeviceClientService
@inject IEdgeModelClientService EdgeModelClientService
@inject IDeviceTagSettingsClientService DeviceTagSettingsClientService
@inject IEdgeDeviceLayoutService EdgeDeviceLayoutService

@implements IDisposable

<AuthorizedContent IsLoading="@IsLoading" IsAuthorized="@IsAuthorized">
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">Create Edge Device</MudText>
    <MudForm Model="@edgeDevice" @ref="form">
        <MudGrid>
            <MudItem xs="12" sm="4" md="3">
                <MudCard>
                    <MudCardHeader Class="DeviceCardHeader">
                        <CardHeaderContent>
                            <MudText Typo="Typo.body2" Class="mb-6" id=@nameof(IoTEdgeModel.Name)>Model: <b>@EdgeModel?.Name</b></MudText>
                            <MudText Typo="Typo.h5" Class="overflow-ellipsis" Align="Align.Center">@(string.IsNullOrEmpty(edgeDevice?.DeviceName) ? edgeDevice?.DeviceId : edgeDevice?.DeviceName)</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="d-flex justify-center mb-4">
                            <MudAvatar Style="height:100px; width: auto; border-radius: 0; background: transparent">
                                <MudImage Src="@EdgeModel?.Image?.ToString()" id="@(nameof(IoTEdgeDevice.Image))" />
                            </MudAvatar>
                        </div>
                    </MudCardContent>
                </MudCard>
                <MudItem xs="12" Class="d-flex justify-center py-2 px-1 mt-4">
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton id="SaveButton" OnClick="Save" Disabled="isProcessing">@saveButtonText</MudButton>
                        <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown">
                            <MudMenuItem OnClick="() => SetSaveButtonText(DeviceSaveAction.Save)">Save</MudMenuItem>
                            <MudMenuItem OnClick="() => SetSaveButtonText(DeviceSaveAction.SaveAndAddNew)">Save and add new</MudMenuItem>
                            <MudMenuItem OnClick="() => SetSaveButtonText(DeviceSaveAction.SaveAndDuplicate)">Save and duplicate</MudMenuItem>
                        </MudMenu>
                    </MudButtonGroup>
                </MudItem>
            </MudItem>
            <MudItem xs="12" sm="8" md="9">
                <MudTabs Elevation="1" Rounded="true" PanelClass="mt-6 scrollable-tab-content">
                    <MudTabPanel Text="General">
                        <MudExpansionPanels MultiExpansion="true">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudExpansionPanel Text="Details" IsInitiallyExpanded="true">
                                        <TitleContent><MudText Typo="Typo.h6">Details</MudText></TitleContent>
                                        <ChildContent>
                                            <MudGrid>
                                                <MudItem xs="12" md="6">
                                                    @if (duplicateDevice)
                                                    {
                                                        <EdgeDeviceToDuplicateSelector />
                                                    }
                                                    else
                                                    {
                                                        <MudAutocomplete T="IoTEdgeModel"
                                                                         id="@nameof(IoTEdgeModel.ModelId)"
                                                                         @bind-Value="EdgeModel"
                                                                         SearchFunc="@Search"
                                                                         Label="Model*"
                                                                         Dense=true
                                                                         For=@(() => EdgeModel)
                                                                         Variant="Variant.Outlined"
                                                                         ToStringFunc="@(x => x?.Name)"
                                                                         ResetValueOnEmptyText=true
                                                                         Immediate=true
                                                                         Clearable=true
                                                                         CoerceText=true
                                                                         CoerceValue=false>
                                                            <ItemTemplate>
                                                                @context.Name
                                                                <MudText Typo="Typo.subtitle1" Class="mud-input-helper-text">
                                                                    @((!string.IsNullOrEmpty(@context.Description) && @context.Description.Length > 100) ? @context.Description.Substring(0, 100) + "..." : @context.Description)
                                                                </MudText>
                                                            </ItemTemplate>
                                                        </MudAutocomplete>
                                                        @if (edgeDevice.ModelId == null && displayValidationErrorMessages)
                                                        {
                                                            <p class="validation-error-message">The Model is required.</p>
                                                        }
                                                    }

                                                </MudItem>
                                                <MudItem xs="12" md="6">
                                                    @if (Portal.CloudProvider.Equals(CloudProviders.Azure))
                                                    {
                                                        <MudTextField @bind-Value="@edgeDevice.DeviceId"
                                                                      id=@nameof(IoTEdgeDevice.DeviceId)
                                                                      Label="Device ID"
                                                                      Variant="Variant.Outlined"
                                                                      For="@(() => edgeDevice.DeviceId)"
                                                                      HelperText="The device identifier should be of ASCII 7-bit alphanumeric characters plus certain special characters" />

                                                    }
                                                </MudItem>
                                                <MudItem xs="12">
                                                    <MudSwitch @bind-Value="@duplicateDevice" Label="Or select a device to copy" />
                                                </MudItem>
                                                <MudItem xs="12">
                                                    <MudTextField @bind-Value="@edgeDevice.DeviceName"
                                                                  id="@nameof(IoTEdgeDevice.DeviceName)"
                                                                  Label="Device name"
                                                                  Variant="Variant.Outlined"
                                                                  For="@(() => edgeDevice.DeviceName)"
                                                                  Required="true" />
                                                </MudItem>

                                                @if (Portal.CloudProvider.Equals(CloudProviders.Azure))
                                                {
                                                    <MudItem xs="12">
                                                        <MudText>
                                                            <b>Status</b>
                                                        </MudText>
                                                        <MudRadioGroup @bind-SelectedValue="@edgeDevice.IsEnabled" T="bool">
                                                            <MudRadio Value=@(true) Color="Color.Primary">
                                                                Enabled
                                                                <MudText Typo="Typo.subtitle1" Class="mud-input-helper-text">The device <b>can</b> connect to the platform.</MudText>
                                                            </MudRadio>
                                                            <MudRadio Value=@(false) Color="Color.Primary">
                                                                Disabled
                                                                <MudText Typo="Typo.subtitle1" Class="mud-input-helper-text">The device <b>cannot</b> connect to the platform.</MudText>
                                                            </MudRadio>
                                                        </MudRadioGroup>
                                                    </MudItem>
                                                }

                                            </MudGrid>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudItem>
                            </MudGrid>
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudExpansionPanel Text="Tags">
                                        <TitleContent><MudText Typo="Typo.h6" Style=@(CheckTagsError() ? "color: red" : "")>Tags</MudText></TitleContent>
                                        <ChildContent>
                                            <MudGrid>
                                                @foreach (DeviceTagDto tag in TagList)
                                                {
                                                    <MudItem xs="12" md="6">
                                                        <MudTextField @bind-Value="edgeDevice.Tags[tag.Name]" id="@tag.Name" Label="@tag.Label"
                                                                      Required="@tag.Required"
                                                                      Variant="Variant.Outlined" />
                                                    </MudItem>
                                                }
                                            </MudGrid>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudItem>
                            </MudGrid>

                            <MudGrid>
                                <MudItem xs="12">
                                    <MudExpansionPanel Text="Labels">
                                        <TitleContent><MudText Typo="Typo.h6">Labels</MudText></TitleContent>
                                        <ChildContent>
                                            <LabelsEditor ReadOnlyLabels="EdgeModel?.Labels" Labels="edgeDevice.Labels" />
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudItem>
                            </MudGrid>

                        </MudExpansionPanels>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    </MudForm>
</AuthorizedContent>

@code {
    protected override PortalPermissions[] RequiredPermissions { get; } = { PortalPermissions.EdgeDeviceWrite };
    
    private MudForm form;

    private IoTEdgeDevice edgeDevice = new();
    private IEnumerable<IoTEdgeModelListItem> edgeModelList = new List<IoTEdgeModelListItem>();
    private IoTEdgeModel edgeModel;

    [CascadingParameter]
    public Error Error { get; set; }

    private IoTEdgeModel EdgeModel
    {
        get => edgeModel;

        set
        {
            Task.Run(async () => await ChangeModel(value));
        }
    }

    private IEnumerable<DeviceTagDto> TagList { get; set; } = new List<DeviceTagDto>();

    private bool displayValidationErrorMessages;

    private bool isProcessing;
    private bool duplicateDevice;

    private DeviceSaveAction deviceSaveAction = DeviceSaveAction.Save;
    private string saveButtonText = "Save";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        try
        {
            EdgeDeviceLayoutService.RefreshDeviceOccurred += DeviceServiceOnRefreshDeviceOccurred!;
            edgeDevice = EdgeDeviceLayoutService.GetSharedDevice() ?? edgeDevice;
            EdgeModel = EdgeDeviceLayoutService.GetSharedDeviceModel() ?? EdgeModel;

            edgeModelList = await EdgeModelClientService.GetIoTEdgeModelList();

            TagList = await DeviceTagSettingsClientService.GetDeviceTags();

            foreach (var tag in TagList)
            {
                edgeDevice.Tags.TryAdd(tag.Name, string.Empty);
            }
        }
        catch (ProblemDetailsException exception)
        {
            Error?.ProcessProblemDetails(exception);
        }
    }

    public void Dispose()
    {
        EdgeDeviceLayoutService.ResetSharedDevice();
        EdgeDeviceLayoutService.ResetSharedDeviceModel();
        EdgeDeviceLayoutService.RefreshDeviceOccurred -= DeviceServiceOnRefreshDeviceOccurred!;
    }

    public async void Save()
    {
        try
        {
            isProcessing = true;

            await form.Validate();

            if (CheckTagsError())
            {
                Snackbar.Add("One or more validation errors occurred", Severity.Error);

                // Allows to display ValidationError messages for the MudAutocomplete field.
                displayValidationErrorMessages = true;

                isProcessing = false;

                return;
            }

            edgeDevice.ModelId = EdgeModel.ModelId;

            await EdgeDeviceClientService.CreateDevice(edgeDevice);

            Snackbar.Add($"Device {edgeDevice.DeviceId} has been successfully created!", Severity.Success);

            ProcessPostDeviceCreation();
        }
        catch (ProblemDetailsException exception)
        {
            Error?.ProcessProblemDetails(exception);
        }
        finally

        {
            isProcessing = false;
        }
    }

    private bool CheckTagsError()
    {
        bool tagValidationError = false;

        foreach (DeviceTagDto tag in TagList)
        {
            if (tag.Required && string.IsNullOrEmpty(edgeDevice.Tags[tag.Name]))
            {
                tagValidationError = true;
            }
        }
        return tagValidationError;
    }

    private void ProcessPostDeviceCreation()
    {
        switch (deviceSaveAction)
        {
            case DeviceSaveAction.Save:
                NavigationManager.NavigateTo("/edge/devices");
                break;
            case DeviceSaveAction.SaveAndAddNew:
                edgeDevice = EdgeDeviceLayoutService.ResetSharedDevice(TagList.ToList());
                EdgeModel = EdgeDeviceLayoutService.ResetSharedDeviceModel();
                break;
            case DeviceSaveAction.SaveAndDuplicate:
                edgeDevice = EdgeDeviceLayoutService.DuplicateSharedDevice(edgeDevice);
                EdgeModel = EdgeDeviceLayoutService.DuplicateSharedDeviceModel(EdgeModel);
                break;
        }
    }

    /// <summary>
    /// Allows to autocomplete the Device Model field in the form.
    /// </summary>
    /// <param name="value">Text entered in the field</param>
    /// <returns>Item of the device model list that matches the user's value</returns>
    private async Task<IEnumerable<IoTEdgeModel>> Search(string value)
    {
        // In real life use an asynchronous function for fetching data from an api.
        await Task.Delay(0);

        // if text is null or empty, show complete list
        if (string.IsNullOrEmpty(value))
            return edgeModelList
                    .Select(m => new IoTEdgeModel
                    {
                        ModelId = m.ModelId,
                        Name = m.Name
                    }); ;

        return edgeModelList
                    .Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
                    .Select(m => new IoTEdgeModel
                    {
                        ModelId = m.ModelId,
                        Name = m.Name
                    });
    }

    public async Task ChangeModel(IoTEdgeModel edgeModel)
    {
        try
        {
            this.edgeModel = await EdgeModelClientService.GetIoTEdgeModel(edgeModel.ModelId);

            edgeDevice = new IoTEdgeDevice()
            {
                DeviceId = edgeDevice.DeviceId,
                DeviceName = edgeDevice.DeviceName,
                ModelId = edgeModel?.ModelId!,
                Image = edgeModel?.Image!,
                Tags = edgeDevice.Tags,
                IsEnabled = edgeDevice.IsEnabled
            };

            if (edgeModel == null || string.IsNullOrWhiteSpace(edgeModel.ModelId))
            {
                return;
            }

        }
        catch (ProblemDetailsException exception)
        {
            Error?.ProcessProblemDetails(exception);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SetSaveButtonText(DeviceSaveAction saveAction)
    {
        deviceSaveAction = saveAction;
        saveButtonText = deviceSaveAction switch
        {
            DeviceSaveAction.Save => "Save",
            DeviceSaveAction.SaveAndAddNew => "Save and add new",
            DeviceSaveAction.SaveAndDuplicate => "Save and duplicate",
            _ => saveButtonText
        };
    }

    private void DeviceServiceOnRefreshDeviceOccurred(object sender, EventArgs e)
    {
        edgeDevice = EdgeDeviceLayoutService.GetSharedDevice();
        EdgeModel = EdgeDeviceLayoutService.GetSharedDeviceModel();
        StateHasChanged();
    }
}
