@page "/planning/{PlanningId}"
@inherits AuthorizedComponentBase

@attribute [Authorize]

@inject IPlanningClientService PlanningClientService
@inject IScheduleClientService ScheduleClientService
@inject IDeviceModelsClientService DeviceModelsClientService
@inject ILoRaWanDeviceModelsClientService LoRaWanDeviceModelsClientService

<AuthorizedContent IsLoading="@IsLoading" IsAuthorized="@IsAuthorized">
    <EditPlanning Planning=@Planning ScheduleList=@ScheduleList InitScheduleList=@(new List<ScheduleDto>(ScheduleList)) Mode="Edit" SelectedModel="@DeviceModel.Name" CanWrite="@canWrite"/>
</AuthorizedContent>

@code {
    // Specify which permissions are required for this page
    protected override PortalPermissions[] RequiredPermissions { get; } = { PortalPermissions.PlanningRead };
    private bool canWrite;

    public List<ScheduleDto> ScheduleList { get; } = new() { };
    public PlanningDto Planning { get; set; } = new();
    public DeviceModelDto DeviceModel { get; } = new();

    [Parameter]
    public string PlanningId { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Planning = await PlanningClientService.GetPlanning(PlanningId);

        List<ScheduleDto> newSchedule = await ScheduleClientService.GetSchedules();
        ScheduleList.AddRange(newSchedule.Where(obj => obj.PlanningId == PlanningId));

        // Check if user has write permission for conditional UI elements
        canWrite = await HasPermissionAsync(PortalPermissions.PlanningWrite);
    }
}
