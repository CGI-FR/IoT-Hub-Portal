@page "/users"
@inherits AuthorizedComponentBase

@attribute [Authorize]

@inject IUserClientService UserClientService
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<AuthorizedContent IsLoading="@IsLoading" IsAuthorized="@IsAuthorized">
    <MudPaper Class="pa-4">
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
            <MudText Typo="Typo.h6">Users</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="search" Placeholder="Search name or email" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Dense="true" Immediate="true" OnKeyUp="@(_ => Reload())" />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="Reload" />
        </MudStack>

        <MudTable T="UserModel" ServerData="LoadServer" Dense="true" Hover="true" @ref="table">
            <HeaderContent>
                <MudTh style="width:30%">Name</MudTh>
                <MudTh style="width:35%">Email</MudTh>
                <MudTh style="width:20%">Principal Id</MudTh>
                <MudTh style="width:15%" class="text-center">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.GivenName</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Principal Id">@context.PrincipalId</MudTd>
                <MudTd DataLabel="Actions" Class="text-center">
                    <MudTooltip Text="Details"><MudIconButton Icon="@Icons.Material.Filled.Visibility" OnClick="() => GoToDetails(context)" /></MudTooltip>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No users found</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudProgressCircular Indeterminate="true" />
            </LoadingContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="@pageSizeOptions" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</AuthorizedContent>

@code {
    // Specify which permissions are required for this page
    protected override PortalPermissions[] RequiredPermissions { get; } = { PortalPermissions.UserRead };

    private MudTable<UserModel> table = default!;
    private string search = string.Empty;
    private readonly int[] pageSizeOptions = { 5, 10, 20 };

    private async Task<TableData<UserModel>> LoadServer(TableState state)
    {
        try
        {
            var uri = $"api/users?pageNumber={state.Page}&pageSize={state.PageSize}";
            if (!string.IsNullOrWhiteSpace(search))
            {
                var esc = Uri.EscapeDataString(search);
                uri += $"&searchName={esc}&searchEmail={esc}";
            }
            var result = await UserClientService.GetUsers(uri);
            return new TableData<UserModel> { Items = result.Items, TotalItems = result.TotalItems };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load users: {ex.Message}", Severity.Error);
            return new TableData<UserModel> { Items = Array.Empty<UserModel>(), TotalItems = 0 };
        }
    }

    private void Reload() => table?.ReloadServerData();

    private void GoToDetails(UserModel model)
    {
        if (!string.IsNullOrEmpty(model.Id))
            Nav.NavigateTo($"/users/{model.Id}");
    }
}
