@page "/lorawan/concentrators/{DeviceId}"
@inherits AuthorizedComponentBase
@using IoTHub.Portal.Client.Validators

@attribute [Authorize]

@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILoRaWanConcentratorClientService LoRaWanConcentratorsClientService

<MudTooltip Text="Return" Placement="Placement.Left">
    <MudFab StartIcon="@Icons.Material.Outlined.ArrowBack" Color="Color.Secondary" Size="Size.Small" OnClick="Return" id="returnButton" />
</MudTooltip>
<MudTooltip Placement="Placement.Top">
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4"> LoRaWAN Concentrator</MudText>
</MudTooltip>

<AuthorizedContent IsLoading="@IsLoading" IsAuthorized="@IsAuthorized">
    <MudForm Model="@Concentrator" @ref="form">
        <MudGrid>
            <MudItem xs="12" sm="4" md="3">
                <MudCard>
                    <MudCardHeader Class="DeviceCardHeader">
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5" Class="overflow-ellipsis" Align="Align.Center">@(string.IsNullOrEmpty(Concentrator.DeviceName) ? Concentrator.DeviceId : Concentrator.DeviceName)</MudText>
                        </CardHeaderContent>
                        <CardHeaderAvatar>
                            @if (Concentrator.IsConnected)
                            {
                                <MudTooltip Text="Concentrator is connected">
                                    <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="Color.Success" />
                                </MudTooltip>
                            }
                            else
                            {
                                <MudTooltip Text="Concentrator is not connected">
                                    <MudIcon Icon="@Icons.Material.Filled.WifiOff" Color="Color.Error" />
                                </MudTooltip>
                            }
                        </CardHeaderAvatar>
                    </MudCardHeader>
                </MudCard>
                @if (canWrite)
                {
                    <MudItem xs="12" Class="d-flex justify-space-around py-2 px-1 mt-4">
                        <MudButton Variant="Variant.Filled" Class="mx-1" Color="Color.Error" OnClick="DeleteDevice" Disabled="IsLoading">Delete device</MudButton>
                        <MudButton Variant="Variant.Filled" Class="mx-1" Color="Color.Primary" OnClick="SaveDevice" id="saveButton" Disabled="IsLoading">Save Changes</MudButton>
                    </MudItem>
                }
            </MudItem>
            <MudItem xs="12" sm="8" md="9">
                <MudTabs Elevation="1" Rounded="true" PanelClass="mt-6 scrollable-tab-content">
                    <MudTabPanel Text="General">
                        <MudExpansionPanels MultiExpansion="true">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudExpansionPanel Text="Details" IsInitiallyExpanded="true">
                                        <TitleContent><MudText Typo="Typo.h6">Details</MudText></TitleContent>
                                        <ChildContent>
                                            <MudGrid>
                                                <MudItem xs="12" md="6">
                                                    <MudTextField @bind-Value="@Concentrator.DeviceId"
                                                                  Label="Device ID"
                                                                  Variant="Variant.Outlined"
                                                                  Required="true"
                                                                  Disabled="true" />
                                                </MudItem>
                                                <MudItem xs="12" md="6">
                                                    <MudTextField @bind-Value="@Concentrator.DeviceName"
                                                                  Label="Device name"
                                                                  Variant="Variant.Outlined"
                                                                  Required="true"
                                                                  Disabled="@(!canWrite)" />
                                                </MudItem>
                                                <MudItem xs="12" md="6">
                                                    <MudTextField For="@(() => Concentrator.ClientThumbprint)"
                                                                  Mask="@MaskThumbprint"
                                                                  HelperText="ClientThumbprint must contain 40 hexadecimal characters"
                                                                  @bind-Value="@Concentrator.ClientThumbprint" Label="Client Certificate Thumbprint" Variant="Variant.Outlined"
                                                                  Disabled="@(!canWrite)" />
                                                </MudItem>
                                                <MudItem xs="12" md="6">
                                                    <MudSelect T="string" Label="Region" Variant="Variant.Outlined"
                                                               @bind-Value="@Concentrator.LoraRegion"
                                                               Required="true"
                                                               Disabled="@(!canWrite)">
                                                        @foreach (var frequencyPlan in frequencyPlans.OrderBy(c => c.Name))
                                                        {
                                                            <MudSelectItem Value="@(frequencyPlan.FrequencyPlanId)">@frequencyPlan.Name</MudSelectItem>
                                                        }
                                                    </MudSelect>
                                                </MudItem>
                                                <MudItem xs="12">
                                                    <MudText>
                                                        <b>Status</b>
                                                    </MudText>
                                                    <MudRadioGroup @bind-SelectedValue="@Concentrator.IsEnabled" T="bool"
                                                                   Disabled="@(!canWrite)">
                                                        <MudRadio Value=@(true)
                                                                  Color="Color.Primary">
                                                            Enabled
                                                            <MudText Typo="Typo.subtitle1" Class="mud-input-helper-text">The device <b>can</b> connect to the platform.</MudText>
                                                        </MudRadio>
                                                        <MudRadio Value=@(false)
                                                                  Color="Color.Primary">
                                                            Disabled
                                                            <MudText Typo="Typo.subtitle1" Class="mud-input-helper-text">The device <b>cannot</b> connect to the platform.</MudText>
                                                        </MudRadio>
                                                    </MudRadioGroup>
                                                </MudItem>
                                            </MudGrid>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudItem>
                            </MudGrid>
                        </MudExpansionPanels>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    </MudForm>
</AuthorizedContent>

@code {
    protected override PortalPermissions[] RequiredPermissions { get; } = { PortalPermissions.ConcentratorRead };
    private bool canWrite;

    [CascadingParameter]
    public Error? Error { get; set; } = default!;

    [Parameter]
    public string DeviceId { get; set; } = default!;

    private ConcentratorDto Concentrator { get; set; } = new();
    private MudForm form = default!;
    private ConcentratorValidator concentratorValidator = new();
    private List<FrequencyPlan> frequencyPlans = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        try
        {
            IsLoading = true;
            frequencyPlans.AddRange(await LoRaWanConcentratorsClientService.GetFrequencyPlans());
            Concentrator = await LoRaWanConcentratorsClientService.GetConcentrator(DeviceId);

            // Check if user has write permission for conditional UI elements
            canWrite = await HasPermissionAsync(PortalPermissions.ConcentratorWrite);
        }
        catch (ProblemDetailsException exception)
        {
            Error?.ProcessProblemDetails(exception);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void Return() => NavigationManager.NavigateTo("/lorawan/concentrators");

    public PatternMask MaskThumbprint = new("XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX")
    {
        MaskChars = new[] { new MaskChar('X', "[0-9a-fA-F]") },
        CleanDelimiters = false,
        Transformation = AllUpperCase
    };

    private static char AllUpperCase(char c) => c.ToString().ToUpperInvariant()[0];


    /// <summary>
    /// Sends a POST request to the DevicesController, to update the device in the Azure IoT Hub
    /// </summary>
    public async void SaveDevice()
    {
        IsLoading = true;

        try
        {
            await form.Validate();
            if (!concentratorValidator.Validate(Concentrator).IsValid)
            {
                Snackbar.Add($"One or more validation errors occurred", Severity.Error);

                IsLoading = false;

                return;
            }

            await LoRaWanConcentratorsClientService.UpdateConcentrator(Concentrator);

            // Prompts a snack bar to inform the action was successful
            Snackbar.Add($"Device {Concentrator.DeviceId} has been successfully updated!\r\nPlease note that changes might take some minutes to be visible in the list...", Severity.Success);

            // Go back to the list of device
            NavigationManager.NavigateTo("lorawan/concentrators");
        }
        catch (ProblemDetailsException exception)
        {
            Error.ProcessProblemDetails(exception);
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Prompts a pop-up windows to confirm the device's deletion.
    /// </summary>
    /// <returns></returns>
    private async Task DeleteDevice()
    {
        IsLoading = true;

        var parameters = new DialogParameters { { "deviceId", Concentrator.DeviceId } };
        var result = await DialogService.Show<DeleteConcentratorPage>("Confirm Deletion", parameters).Result;

        IsLoading = false;

        if (result.Canceled)
        {
            return;
        }

        // Go back to the list of devices after the deletion
        NavigationManager.NavigateTo("lorawan/concentrators");
    }
}
